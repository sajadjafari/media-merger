var T=Object.defineProperty,b=Object.defineProperties;var x=Object.getOwnPropertyDescriptors;var S=Object.getOwnPropertySymbols;var M=Object.prototype.hasOwnProperty,R=Object.prototype.propertyIsEnumerable;var E=(n,t,e)=>t in n?T(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,c=(n,t)=>{for(var e in t||(t={}))M.call(t,e)&&E(n,e,t[e]);if(S)for(var e of S(t))R.call(t,e)&&E(n,e,t[e]);return n},d=(n,t)=>b(n,x(t));import{interval as A}from"rxjs";import P from"audio-merger";import{nanoid as v}from"nanoid";var f=class{constructor(t){this.width=1920;this.height=1080;this.fps=40;this.isRendering=!1;this.sources=new Map;this.destroyed=!1;this.rxIntervalSub=null;this.mixer=null;this.translatePositionToVertices=t=>{let{width:e,height:r}=this.canvas,{x:i,y:s,w:o,h}=this.getPosition(t),a=2/e,g=2/r,l=a*i-1,u=a*(i+o)-1,m=g*(r-s)-1,p=g*(r-(s+h))-1;return new Float32Array([l,m,l,p,u,m,u,p])};this.debug=(t==null?void 0:t.debug)||!1;let e=document.createElement("canvas");if(!("AudioContext"in window&&"createMediaElementSource"in AudioContext.prototype))throw"AudioContext is not supported!";if(!e.captureStream)throw"Canvas is not supported!";if(!e.getContext("webgl2"))throw"WebGL is not supported!";this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.addEventListener("webglcontextlost",l=>console.error(l),!1),this.gl=this.canvas.getContext("webgl2",{alpha:!1,premultipliedAlpha:!1,antialias:!0,preserveDrawingBuffer:!1,powerPreference:"default"}),this.gl.viewport(0,0,this.canvas.width,this.canvas.height);let r=`#version 300 es
            layout(location=0) in vec2 aPosition;
            layout(location=1) in vec2 aTextCoords;
            out vec2 vTextCoords;
            void main() {
                vTextCoords = aTextCoords;
                gl_Position = vec4(aPosition, 0.0, 1.0);
            }
        `,i=`#version 300 es
            precision mediump float;
            uniform sampler2D uSampler;
            in vec2 vTextCoords;
            out vec4 fragColor;
            void main() {
                fragColor = texture(uSampler, vTextCoords);
            }
        `;this.program=this.gl.createProgram();let s=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(s,r),this.gl.compileShader(s),this.gl.attachShader(this.program,s);let o=this.gl.createShader(this.gl.FRAGMENT_SHADER);if(this.gl.shaderSource(o,i),this.gl.compileShader(o),this.gl.attachShader(this.program,o),this.gl.linkProgram(this.program),this.debug){let l=this.gl.getExtension("WEBGL_debug_renderer_info");if(l){let u=this.gl.getParameter(l.UNMASKED_VENDOR_WEBGL),m=this.gl.getParameter(l.UNMASKED_RENDERER_WEBGL);console.log(`DEBUG_INFO: Vendor: ${u}, Renderer: ${m}`,l)}this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)||console.error("ERROR compiling vertex shader!",this.gl.getShaderInfoLog(s)),this.gl.getShaderParameter(o,this.gl.COMPILE_STATUS)||console.error("ERROR compiling fragment shader!",this.gl.getShaderInfoLog(o)),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)||console.error("Error linking program:",this.gl.getProgramInfoLog(this.program))}this.gl.useProgram(this.program);let h=this.gl.createBuffer(),a=new Float32Array([0,1,0,0,1,1,1,0]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,h),this.gl.bufferData(this.gl.ARRAY_BUFFER,a,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(1,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(1);let g=this.gl.createTexture();this.gl.uniform1i(this.gl.getUniformLocation(this.program,"uSampler"),0),this.gl.bindTexture(this.gl.TEXTURE_2D,g),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.MIRRORED_REPEAT),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.result=this.canvas.captureStream(this.fps)}getPosition(t){if(t)return t;let e=this.sources.size+1,r=Math.ceil(Math.sqrt(e)),i=Math.floor(this.canvas.width/r),s=Math.floor(this.canvas.height/r),o=h=>{let a=Math.floor(h/r);return{x:h%r*i,y:a*s}};return this.sources.size&&[...this.sources].forEach(([,h],a)=>{a<this.sources.size&&this.updatePosition(h.id,d(c({},o(a)),{w:i,h:s}))}),d(c({},o(this.sources.size)),{w:i,h:s})}createVideoElement(t){let e=document.createElement("video");return e.muted=!0,e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.opacity="0",e.srcObject=t,e.play().catch(r=>{console.error("Merger failed to add stream",r)}),e}draw(){var t;try{if(this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.clearDepth(this.gl.getParameter(this.gl.DEPTH_CLEAR_VALUE)),this.gl.clearColor(0,0,0,0),!this.isRendering){(t=this.rxIntervalSub)!=null&&t.unsubscribe&&this.rxIntervalSub.unsubscribe();return}this.sources.forEach(({element:e,vertices:r})=>{if(!e||e instanceof HTMLVideoElement&&e.readyState<3)return;let i=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(0,2,this.gl.FLOAT,!1,2*4,0),this.gl.enableVertexAttribArray(0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,e instanceof HTMLVideoElement?e.videoWidth:e.width,e instanceof HTMLVideoElement?e.videoHeight:e.height,0,this.gl.RGB,this.gl.UNSIGNED_BYTE,e),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),this.gl.deleteBuffer(i)})}catch(e){console.error(e)}}start(){this.isRendering=!0,this.rxIntervalSub=A(1e3/this.fps).subscribe(()=>this.draw())}addSource({id:t,index:e,name:r,source:i,position:s,type:o}){var a;let h=t||v();if(this.destroyed)throw"StudioMerger: Merger has been destroyed, Please create a new instance!";if(this.mixer||(this.mixer=new P),(a=this.result)!=null&&a.getAudioTracks().length||this.result.addTrack(this.mixer.getOutputStream().getAudioTracks()[0]),i instanceof MediaStream&&(o==="sound"||i.getAudioTracks().length>0)&&this.mixer.addSource(r,i),o==="sound"&&i instanceof HTMLMediaElement&&(i.id=h,i.play(),this.mixer.addSource(r,i)),o==="visual"){let g=t||(i instanceof MediaStream?i.id:v());i instanceof MediaStream||(i.id=g),i instanceof HTMLVideoElement&&i.play(),this.sources.set(i.id,{id:g,index:e||this.sources.size,source:i,vertices:this.translatePositionToVertices(s),position:this.getPosition(s),element:i instanceof MediaStream?this.createVideoElement(i):i})}(!this.isRendering&&this.sources.size||this.mixer.getSources().size)&&this.start()}removeStream(t){this.mixer&&this.mixer.getSources().has(t)&&this.mixer.removeSource(t);let e=this.sources.get(t);e&&(e.element&&e.element.remove(),e.source instanceof MediaStream&&e.source.getTracks().forEach(r=>{r.enabled=!1,r.stop(),e.source.removeTrack(r)}),this.sources.delete(t)),this.sources.size||setTimeout(()=>{this.gl&&(this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.clearDepth(this.gl.getParameter(this.gl.DEPTH_CLEAR_VALUE)))},50)}getSources(){let t=[];return this.sources.forEach(e=>t.push(Object.freeze(e))),Object.freeze(t)}updateIndex(t,e){let r=this.sources.get(t);r&&(this.sources.set(t,d(c({},r),{index:e})),this.sortSources())}updatePosition(t,e){let r=this.sources.get(t);r&&this.sources.set(t,d(c({},r),{vertices:this.translatePositionToVertices(e)}))}sortSources(){let t=Array.from(this.sources);t.length&&(this.sources=new Map(t.sort((e,r)=>e[1].index-r[1].index)))}setOutputSize(t,e){this.width=t,this.height=e,this.canvas.setAttribute("width",t.toString()),this.canvas.setAttribute("height",e.toString()),this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}destroy(){var t;for(let[e]of Array.from(this.sources))this.removeStream(e);if(this.mixer)for(let[e]of Array.from(((t=this.mixer)==null?void 0:t.getSources())||new Map))this.mixer.removeSource(e);this.mixer&&this.mixer.destroy(),this.sources=new Map,this.isRendering=!1,this.canvas.remove(),this.rxIntervalSub=null,this.result.getTracks().forEach(e=>{e.enabled=!1,e.stop(),this.result.removeTrack(e)}),this.destroyed=!0}};export{f as default};
//# sourceMappingURL=index.mjs.map